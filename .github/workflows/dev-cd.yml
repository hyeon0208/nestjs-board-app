name: Deploy Application

on:
  workflow_dispatch:
    inputs:
      deployment_type:
        description: '배포 환경 선택'
        required: true
        type: choice
        options:
        - '개발환경 (dev) - 일반 배포'
        - '운영환경 (prod) - ⚠️ 아래 확인 필수 ⚠️'
      prod_confirmation:
        description: '🔴 운영환경 배포 최종 확인 🔴'
        required: true
        type: choice
        options:
        - '운영환경에 배포하지 않음'
        - '네, 운영환경에 배포하겠습니다'

jobs:
  validate:
    name: 배포 환경 검증
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
    - name: 환경 설정 및 검증
      run: |
        if [[ "${{ github.event.inputs.deployment_type }}" == *"운영환경"* ]]; then
          echo "ENVIRONMENT=prod" >> $GITHUB_ENV
          echo "📍 운영환경 배포가 선택되었습니다"
          
          if [ "${{ github.event.inputs.prod_confirmation }}" != "네, 운영환경에 배포하겠습니다" ]; then
            echo "❌ 운영환경 배포 확인이 제대로 되지 않았습니다"
            echo "⚠️  운영환경 배포를 위해서는 '네, 운영환경에 배포하겠습니다'를 선택해야 합니다"
            exit 1
          fi
          echo "✅ 운영환경 배포가 확인되었습니다"
        else
          echo "ENVIRONMENT=dev" >> $GITHUB_ENV
          echo "🔧 개발환경 배포가 선택되었습니다"
        fi
    
    - name: 브랜치 확인
      run: echo "✅ main 브랜치에서 실행 중입니다"